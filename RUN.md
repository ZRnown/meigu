# 系统运行流程说明

## 🚀 启动方式

### 方式1：定时任务模式（推荐）
```bash
npm start
# 或
node index.js
```
程序会持续运行，每天在配置的时间（如 23:00）自动执行任务。

### 方式2：立即执行一次
```bash
npm run run-now
# 或
node index.js --run-now
```
立即执行一次任务，不等待定时时间。

---

## 📋 完整运行流程

### 第一步：关键词识别

系统会扫描 `watchDirectory` 目录中的所有 `.html` 文件，通过文件名中的**关键词**匹配股票配置：

```javascript
// 示例文件名
"2025-12-12_03;34_SPX_gamma.html"  → 匹配关键词 "spx"
"2025-12-12_03;32_tsm_gamma.html"  → 匹配关键词 "tsm"
```

**匹配逻辑**：
1. 将文件名转为小写
2. 检查是否包含配置中的关键词（不区分大小写）
3. 如果匹配，使用对应的股票配置（Webhook URL、股票名称等）

**代码位置**：`scheduler.js` 的 `matchStockConfig()` 函数

---

### 第二步：检查是否已处理

系统会检查文件是否已经处理过，避免重复处理：

**检查逻辑**：
- 使用 `stockKey`（关键词，如 "spx"）和文件路径作为唯一标识
- 查询 `history.json` 文件中的历史记录
- 如果已处理，跳过该文件

**代码位置**：`scheduler.js` 的 `scanHtmlFiles()` 函数

---

### 第三步：转换为图片

对于未处理的文件，系统会：
1. 使用 Puppeteer 打开 HTML 文件
2. 等待 Plotly 图表渲染完成（5秒）
3. 使用 `Plotly.toImage()` 将图表导出为 PNG 图片
4. 保存到当前目录

**代码位置**：`convert.js` 的 `convertHtmlToImages()` 函数

---

### 第四步：发送到 Discord

将生成的图片通过 Webhook 发送到对应的 Discord 频道：

```javascript
// 发送消息格式
"📊 SPX Gamma Hedging 图表 - 2025-12-12"
+ [图片1.png]
+ [图片2.png]
```

**代码位置**：`discord.js` 的 `sendImagesToDiscord()` 函数

---

### 第五步：记录历史

将处理结果保存到 `history.json`：

```json
{
  "spx": [
    {
      "date": "2025-12-12",
      "htmlFile": "/path/to/2025-12-12_03;34_SPX_gamma.html",
      "imagePaths": ["2025-12-12_03;34_SPX_gamma_xxx.png"],
      "processedAt": "2025-12-12T23:00:00.000Z"
    }
  ],
  "tsm": [...]
}
```

**重要**：每个股票的历史记录独立存储，不会混合。

**代码位置**：`history.js` 的 `recordProcessed()` 方法

---

### 第六步：AI 分析（从第二天开始）

**触发条件**：
- 当前股票（如 "spx"）的历史记录中**至少有 2 天的数据**
- 系统会自动检查，如果满足条件就执行分析

**分析流程**：
1. 获取该股票最近 2 天的历史记录
2. 收集这 2 天的所有图片
3. 调用 DeepSeek API 进行分析
4. 将分析结果发送到 Discord

**代码位置**：`scheduler.js` 的 `processHtmlFile()` 函数（第 101-140 行）

---

## 📅 定时任务执行时间

系统使用 `node-cron` 实现定时任务：

```javascript
// config.json 中配置
"scheduleTime": "23:00"

// 转换为 cron 表达式
"0 23 * * *"  // 每天 23:00 执行
```

**执行时机**：
- 每天在配置的时间（如 23:00）自动执行
- 扫描目录 → 识别关键词 → 处理文件 → 发送图片 → AI 分析

---

## 🔄 完整示例流程

### 第一天（2025-12-12）

```
23:00 定时任务触发
  ↓
扫描目录，发现文件：
  - 2025-12-12_03;34_SPX_gamma.html (关键词: "spx")
  - 2025-12-12_03;32_tsm_gamma.html (关键词: "tsm")
  ↓
转换为图片
  ↓
发送到 Discord（SPX → SPX Webhook, TSM → TSM Webhook）
  ↓
记录历史（history.json）
  ↓
检查 AI 分析条件：只有 1 天数据，不执行分析
```

### 第二天（2025-12-13）

```
23:00 定时任务触发
  ↓
扫描目录，发现新文件：
  - 2025-12-13_03;34_SPX_gamma.html
  - 2025-12-13_03;32_tsm_gamma.html
  ↓
转换为图片
  ↓
发送到 Discord
  ↓
记录历史
  ↓
检查 AI 分析条件：
  - SPX: 有 2 天数据（12-12, 12-13）✅
  - TSM: 有 2 天数据（12-12, 12-13）✅
  ↓
执行 AI 分析：
  - 收集 SPX 最近 2 天的图片
  - 调用 DeepSeek API 分析
  - 发送分析结果到 Discord
  - 对 TSM 执行相同流程
```

### 第三天及以后

```
每天重复第二天流程：
1. 处理新文件
2. 发送图片
3. 记录历史
4. 使用最近 2 天的数据进行 AI 分析
```

---

## 🔍 关键点说明

### 1. 关键词识别
- **不区分大小写**：`SPX`、`spx`、`Spx` 都能匹配
- **部分匹配**：文件名包含关键词即可，如 `2025-12-12_SPX_gamma.html`
- **多个关键词**：配置中可以设置多个关键词，只要匹配其中一个即可

### 2. 股票分组
- 使用 `stockKey`（第一个关键词）作为分组标识
- 每个股票的历史记录独立存储
- AI 分析时只使用同一股票的数据，**不会混合**

### 3. AI 分析时机
- **第一天**：只有 1 天数据，不执行分析
- **第二天开始**：有 2 天数据，执行分析
- **每天**：使用最近 2 天的数据进行对比分析

### 4. 历史记录管理
- 记录保存在 `history.json`
- 按股票分组存储
- 按日期排序
- 删除 `history.json` 可重置历史（会重新处理所有文件）

---

## 🛠️ 调试技巧

### 查看历史记录
```bash
cat history.json
```

### 立即测试
```bash
npm run run-now
```

### 查看日志
程序会输出详细的处理日志，包括：
- 📄 处理的文件
- ✓ 成功操作
- ✗ 失败操作
- 🤖 AI 分析状态

---

## ⚠️ 注意事项

1. **程序需要持续运行**：定时任务模式需要程序一直运行
2. **文件命名规范**：建议使用 `YYYY-MM-DD_*_关键词_*.html` 格式
3. **历史记录**：不要手动修改 `history.json`，可能导致重复处理或数据混乱
4. **网络连接**：需要网络连接才能发送到 Discord 和调用 DeepSeek API

